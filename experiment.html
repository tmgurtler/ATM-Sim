<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta content="width=300, initial-scale=1" name="viewport">
        
        <title>NYIT ATM</title>

        <link rel="stylesheet" type="text/css" href="style/main.css">
        <link rel="stylesheet" type="text/css" media="screen and (max-width: 800px), screen and (max-height: 800px)" href="style/medium.css">
        <link rel="stylesheet" type="text/css" media="screen and (max-width: 580px)" href="style/small.css">
        <link rel="stylesheet" type="text/css" media="screen and (-webkit-min-device-pixel-ratio: 1.5), (min--moz-device-pixel-ratio: 1.5), (-o-min-device-pixel-ratio: 3 / 2), (min-device-pixel-ratio: 1.5)" href="style/ratio.css">

        <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    </head>

    <body oncopy="return false" oncut="return false" onpaste="return false" onload="start()" cz-shortcut-listen="true">
        <div class="wrapper">
            <div class="main content clearfix">
                <div id="error-alert" class="alert">
                    <b>Error!</b> The typed PIN is wrong! Please type the correct PIN.
                </div>
                
                <div id="success-alert" class="alert">
                    <b>Good!</b> The typed PIN is correct!
                </div>
                
                <div class="banner">
                    <h1>
                        Please type <b id="typeToContinue" style="font-family:monospace;"></b>
                    </h1>
                </div>
      
                <div class="main-content shift-form">
                    <div class="card signin-card shift-form">
                        
                        <img class="circle-mask" src="http://www.rutlandherald.com/wp-content/uploads/2017/03/default-user.png">

                        <form novalidate="" method="" action="" id="gaia_loginform">
                            <input name="Page" type="hidden" value="PasswordSeparationSignIn">
                            
                            <div class="form-panel second">
                                <div class="slide-in">
                                    <div>
                                        <p class="hidden" id="profile-name">Profile Name</p>
                                        <br />
                                        <span class="hidden" id="email-display">{{ uid }}</span>
                                    </div>
                                </div>
                                
                                <div id="password-shown"></div>
                                
                                <input id="Email-hidden" name="Email" type="email" spellcheck="false" class="hidden" value="{{ uid }}" readonly="" autocomplete="off">
                              
                                <label class="hidden-label" for="Passwd">Password</label>

                                <input id="Passwd" name="Passwd" type="password" placeholder="Password" onkeydown="getTime(event)" onkeypress="getKey(event)" class="" autofocus="">
                            </div>

                            <input id="signIn" onclick="checkPWD()" name="signIn" class="rc-button rc-button-submit" type="button" value="Sign in"> <!-- submit -->
                  
                            <label class="hidden remember">
                                <input class="hidden" id="PersistentCookie" name="PersistentCookie" type="checkbox" value="yes" checked="checked">
                          
                                <span class="hidden">
                                    Stay signed in
                                </span>
                          
                                <div class="bubble-wrap" role="tooltip">
                                    <div class="bubble-pointer"></div>
                                    <div class="bubble">
                                        For your convenience, keep this checked. On shared devices, additional precautions are recommended.
                                        <a href="https://support.google.com/accounts/?p=securesignin&amp;hl=en" target="_blank">Learn more</a>
                                    </div>
                                </div>
                            </label>

                            <input class="hidden" type="hidden" name="rmShown" value="1">
                  
                            <a id="link-forgot-passwd" class="hidden need-help" href="#">
                                Forgot password?
                            </a>
                        </form>
                    </div>

                    <div class="card-mask-wrap shift-form">
                        <div class="card-mask">
                            <div class="one-google">
                                <p class="create-account">
              
                                    <span id="link-signin-different">
                                        <a href="#">
                                            This webpage collects user data for a scientific experiment by University of Padua, NYIT, UCI.

                                            By participating to the experiment and interacting with this webpage, you agree that information about the timing with which you pressed the keys of your keyboard will be collected. No other personal information is gathered. Data is securely and anonymously collected on a secure database. <br><br>
                                            NEVER TYPE YOUR REAL PASSWORDS HERE! INPUT ONLY THE PASSWORD GIVEN TO PERFORM THE EXPERIMENT!
                                        </a>
                                    </span>
                                    
                                    <span id="link-signup">
                                        <a href="#">
                                        </a>
                                    </span>
                                </p>

                                <div class="hidden">
                                    <center>
                                        <p style ="font-size: 25px;" id="timeLbl"></p>
                                        <p id="result" style ="font-size: 25px;">Session: <span id="session">Training</span> - Attempt: <span id="attempt">1</span></p>
                                        <textarea id="textLog" style="width:90%; height:200px"></textarea>
                                        <!-- <input type="button" id="btnConvert" value="Converti" onclick="convert()" />  -->
                                        <input type="button" onclick="location.href='results.html';" id="btnShowResults" value="See results"/>
                                    </center>
                                    <br />
                                    <center>
                                        <input type="button" onclick="clearLS()" id="btnClear" value="Clear LS"/>
                                    </center>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script type="text/javascript">
            var indirizzo = window.location.href.split('/');
            var volunteerId = "{{ uid }}";
            var pwdToCheck = "";
            var sessionType = "Training";

            if (localStorage.getItem("attempt") === null)
                localStorage.setItem("attempt", 1);

            var c_a = localStorage.getItem("attempt");

            switch(true) {
                case c_a < 4:
                pwdToCheck = "jillie02";
                break;

                case c_a < 7:
                pwdToCheck = "william1";
                break;

                case c_a < 10:
                pwdToCheck = "123brian";
                break;

                case c_a < 13:
                pwdToCheck = "lamondre";
                break;

                default:
                window.location.replace("http://tgurtler.pythonanywhere.com/over");
            }

            document.getElementById("typeToConitnue").innerHTML = pwdToCheck;
            document.getElementById("email-display").innerHTML = volunteerId;
            document.getElementById("session").innerHTML = sessionType;

            function printAlerts() {
                var success = document.getElementById("success-alert");
                var error = document.getElementById("error-alert");
                var curl = window.location.href;
                if (curl.indexOf('?') == -1){
                     //do nothing
                }
                else {
                    curl = curl.split('?')[1]
                    console.log(curl)
                    if (curl[curl.length-1] == "1") {
                        success.style.visibility = "visible";
                    }
                    else {
                        success.style.display = "none";
                        error.style.display = "block";
                    }
                }
            }

            var model = '{ "id": "uuid",' +
            ' "password": "pwd",'+
            ' "attempt": "0",'+
            ' "keystrokes": [] }
            ';

            var charcounter = 0;
            message = JSON.parse(model);

            function start() {
                //startTime();
                printAttempt();
                printAlerts();
            }

            function getTime(event) {
                var x = Date.now();

                if (event.keyCode != 16) {
                    document.getElementById("textLog").innerHTML += (x + " ");
                }
            }

            function getKey(event) {
                document.getElementById("textLog").innerHTML += (String.fromCharCode(event.keyCode) + "\n");
                if (event.keyCode != 13) {
                    if (event.key != pwdToCheck[charcounter]) {
                        charcounter +=1;
                        checkPWD();
                    }

                    charcounter += 1;
                    console.log(charcounter);
                }
            }

            function checkPWD () {
                if (document.getElementById("Passwd").value == pwdToCheck && charcounter == 8) {
                    //alert("The password is correct!");
                    
                    /*************************UPDATE COUNTER*********************/

                    var tent = parseInt(document.getElementById("attempt").innerHTML);
                    tent = tent + 1;
                    localStorage.setItem("attempt", tent);

                    var header = "\nSession: " + document.getElementById("session").innerHTML + " - " + "Attempt: " + document.getElementById("attempt").innerHTML + "\n" ;

                    appendToStorage("timestamp", header);
                    appendToStorage("timestamp", document.getElementById("textLog").value);

                    c = document.getElementById("textLog").value;
                    c = c.split('\n');
                    c.pop(c.length-1); //this line is empty anyways, so get rid of it
                    //c.pop(c.length-1); //rimuove riga con il timestamp del tasto invio
                    
                    for (var i = 0; i < c.length-1 ; i++) {
                        keystroke = c[i].split(" ");
                        message['keystrokes'].push({"timestamp": keystroke[0], "key": keystroke[1]})
                    }

                    message['id']=document.getElementById("email-display").innerHTML;
                    message['password']=document.getElementById("Passwd").value;
                    message['attempt']=document.getElementById("attempt").innerHTML;
                    message = JSON.stringify(message);

                    var http = new XMLHttpRequest();
                    var url = "https://tgurtler.pythonanywhere.com/save/" + message;
                    console.log(url);
                    http.open("GET", url, true);
                    //http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

                    http.onreadystatechange = function() { //Call a function when the state changes.
                        if(http.readyState == 4 && http.status == 200) {
                            var curl = window.location.href;
                            if (curl.indexOf('?') == -1) {
                                //do nothing
                            }
                            else {
                                curl = curl.split('?')[0];
                            }

                            window.location.href = curl +'?last=1';
                            //location.reload();
                        }
                    }

                    http.send();
                }
                else {
                    var curl = window.location.href;
                    if (curl.indexOf('?') == -1){
                        //do nothing
                    }
                    else {
                        curl = curl.split('?')[0]
                    }

                    //alert("Wrong password!");
                    window.location.href = curl+'?last=0';
                    //location.reload();
                }
            }

            function startTime() {
                var today = new Date();
                var h = today.getHours();
                var m = today.getMinutes();
                var s = today.getSeconds();
                var day = today.getDate();
                var month = today.getMonth() + 1;
                var year = today.getFullYear();
                m = checkTime(m);
                s = checkTime(s);
                document.getElementById('timeLbl').innerHTML = day + "/" + month + "/" + year + " - " + h + ":" + m + ":" + s;
                var t = setTimeout(startTime, 500);
            }

            function checkTime(i) {
                if (i < 10) {
                    i = "0" + i;
                }

                return i;
            }

            function convert() {
                var lines = document.getElementById("textLog").innerHTML.split('\n');
                document.getElementById("textLog").innerHTML="";
                for(var i = 0;i < lines.length-1;i++) {
                    var subline = lines[i].split(' ');

                    if (i==0) {
                        var first=subline[0];
                    }

                    lines[i] = subline[0]- first + '\t' + subline[1] + '\n';
                    document.getElementById("textLog").innerHTML += lines[i];
                }
            }

            document.getElementById("Passwd").addEventListener("keyup", function(event) {
                event.preventDefault();
                if (event.keyCode == 13) {
                    document.getElementById("signIn").click();
                }
            });

            function printAttempt() {
                if (localStorage.getItem("attempt") === null) {
                    localStorage.setItem("attempt", 1);
                }
                else {
                    document.getElementById("attempt").innerHTML = localStorage.getItem("attempt");
                }
            }

            function appendToStorage(name, data) {
                var old = localStorage.getItem(name);
                if(old === null) {
                    old = "";
                }
                localStorage.setItem(name, old + data);
            }

            function clearLS() {
                localStorage.clear();
                location.reload();
            }
        </script>
    </body>
</html>